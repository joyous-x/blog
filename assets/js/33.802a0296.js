(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{555:function(s,e,a){"use strict";a.r(e);var l=a(15),n=Object(l.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"批量写入造成mysql访问慢问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#批量写入造成mysql访问慢问题"}},[s._v("#")]),s._v(" 批量写入造成mysql访问慢问题")]),s._v(" "),a("h2",{attrs:{id:"现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#现象"}},[s._v("#")]),s._v(" 现象")]),s._v(" "),a("p",[s._v("2020.03的某天下午，突然收到同事反馈，产品的某个页面出现'服务无响应'问题")]),s._v(" "),a("h2",{attrs:{id:"跟进"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跟进"}},[s._v("#")]),s._v(" 跟进")]),s._v(" "),a("ul",[a("li",[s._v("由于服务器是分线路访问，可以通过 ping 指令，找到具体的服务器ip，然后本地绑定域名，进行模拟请求，确认问题并查看日志。")]),s._v(" "),a("li",[s._v("发现是mysql数据库响应慢，造成接口响应速度下降 20+ 倍")]),s._v(" "),a("li",[s._v("进行以下操作：\n"),a("ol",[a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 查看\nshow variables like 'slow_query%';\nshow variables like 'long_query_time';\n// 设置\nset global [variablesName]=[Value]\n// 日志输出方式：TABLE,FILE\nshow variables like '%log_output%'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 查看\nshow variables like 'slow_query%';\nshow variables like 'long_query_time';\n// 设置\nset global [variablesName]=[Value]\n// 日志输出方式：TABLE,FILE\nshow variables like '%log_output%'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),s._v("通过以下指令打开、设置并查看慢查询日志"),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 查看\nshow variables like 'slow_query%';\nshow variables like 'long_query_time';\n// 设置\nset global [variablesName]=[Value]\n// 日志输出方式：TABLE,FILE\nshow variables like '%log_output%'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 如果是root帐号，你能看到所有用户的当前连接。如果是其它普通帐号，只能看到自己占用的连接。\nshow full processlist;\n// 状态\nshow status [like '%variables%'];\n// 参数\nshow variables [like '%variables%']\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 如果是root帐号，你能看到所有用户的当前连接。如果是其它普通帐号，只能看到自己占用的连接。\nshow full processlist;\n// 状态\nshow status [like '%variables%'];\n// 参数\nshow variables [like '%variables%']\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),s._v("查看mysql的连接数等状态"),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 如果是root帐号，你能看到所有用户的当前连接。如果是其它普通帐号，只能看到自己占用的连接。\nshow full processlist;\n// 状态\nshow status [like '%variables%'];\n// 参数\nshow variables [like '%variables%']\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])]),s._v(" "),a("li",[s._v("查看mysql使用的内存、cpu、磁盘、网络状况")])])]),s._v(" "),a("li",[s._v("分析\n"),a("ol",[a("li",[s._v("数据库连接数已满(max=1000)")]),s._v(" "),a("li",[s._v("磁盘、网络、cpu、内存 都不高，特别是内存低的很奇怪，只占总内存的 8% 左右，不能有效利用机器性能")]),s._v(" "),a("li",[s._v("慢查询日志：发现发生慢查询的语句，都是使用到了索引、并且索引有效的查询语句")])])]),s._v(" "),a("li",[s._v("猜测是：服务器配置 + 用户流量激增造成\n"),a("ol",[a("li",[s._v("看域名流量，没有异常")]),s._v(" "),a("li",[s._v("mysql配置有异常：key_buffer_size 设置的很小。调整后，问题没有好转")])])]),s._v(" "),a("li",[s._v("查看锁状况\n"),a("ol",[a("li",[s._v("由于相关表使用的是MyISAM引擎，所以通过 "),a("code",[s._v("show status like 'table%'")]),s._v(" 查看锁状态，发现：Table_locks_immediate / Table_locks_waited ~= 2")]),s._v(" "),a("li",[s._v("因为这个库只能通过主从同步进行修改，这时想起相关的运营组最近在进行自动入库操作。")]),s._v(" "),a("li",[s._v("停止后，问题缓解")])])])]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("ul",[a("li",[s._v("问题复盘\n"),a("ol",[a("li",[s._v("这个数据库采用主从结构(一主多从)，异步同步，落盘策略为：sync_binlog=0")]),s._v(" "),a("li",[s._v("自动入库：最近才开始，采用 "),a("code",[s._v("while do { 写入数据(标记无效),校验文件md5,修改标记(有效) }")]),s._v(" "),a("ul",[a("li",[s._v("问题：相关人员说，前两天同样的操作没有出问题啊")]),s._v(" "),a("li",[s._v("确认：当天加上了文件md5校验")]),s._v(" "),a("li",[s._v("猜测：文件校验操作，造成mysql数据被分隔成更多次数刷新到磁盘并触发主从同步动作，造成更加密集的MyISAM表锁。由于，写锁优先级高，造成客户端请求近乎饿死，进而造成连接数打满。")])])]),s._v(" "),a("li",[s._v("处理\n"),a("ul",[a("li",[s._v("考虑到这是个多年轻的项目，这次需要切换 MyISAM 到 innodb")]),s._v(" "),a("li",[s._v("调整Mysql相关参数，尽可能的发挥机器性能")])])])])])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"mysql-知识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-知识"}},[s._v("#")]),s._v(" MYSQL 知识")]),s._v(" "),a("h4",{attrs:{id:"_1-相关命令、参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-相关命令、参数"}},[s._v("#")]),s._v(" 1. 相关命令、参数")]),s._v(" "),a("ul",[a("li",[s._v("落盘策略: "),a("code",[s._v("innodb_flush_log_at_trx_commit 和 sync_binlog")])]),s._v(" "),a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("show slave status\nshow master status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("show slave status\nshow master status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),s._v("查看主从同步状态："),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("show slave status\nshow master status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])]),s._v(" "),a("h4",{attrs:{id:"_2-mysql-的-sql-mode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-mysql-的-sql-mode"}},[s._v("#")]),s._v(" 2. mysql 的 sql_mode:")]),s._v(" "),a("ul",[a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT @@GLOBAL.sql_mode;\nSELECT @@SESSION.sql_mode;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT @@GLOBAL.sql_mode;\nSELECT @@SESSION.sql_mode;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),s._v("查看当前sql-mode"),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT @@GLOBAL.sql_mode;\nSELECT @@SESSION.sql_mode;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 命令\nSET GLOBAL sql_mode = 'modes...';\nSET SESSION sql_mode = 'modes...';\n// my.cnf中配置sql-mode\n[mysqld]\n#set the SQL mode to strict\n#sql-mode=\"modes...\" \nsql-mode = \"STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\"\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 命令\nSET GLOBAL sql_mode = 'modes...';\nSET SESSION sql_mode = 'modes...';\n// my.cnf中配置sql-mode\n[mysqld]\n#set the SQL mode to strict\n#sql-mode=\"modes...\" \nsql-mode = \"STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\"\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),s._v("设置当前sql-mode"),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 命令\nSET GLOBAL sql_mode = 'modes...';\nSET SESSION sql_mode = 'modes...';\n// my.cnf中配置sql-mode\n[mysqld]\n#set the SQL mode to strict\n#sql-mode=\"modes...\" \nsql-mode = \"STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\"\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])]),s._v(" "),a("h4",{attrs:{id:"_3-查看引擎的锁定状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-查看引擎的锁定状态"}},[s._v("#")]),s._v(" 3. 查看引擎的锁定状态")]),s._v(" "),a("ul",[a("li",[s._v("Myisam : "),a("code",[s._v("show status like 'table%'")]),s._v(" "),a("ul",[a("li",[s._v("通过检查 table_locks_waited 和 table_locks_immediate 状态变量分析系统上表锁争夺情况")]),s._v(" "),a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code")]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"})]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code")]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"})]),s._v("表级锁是MyISAM不适合含有大量更新操作和查询操作应用的原因。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("•Table_locks_immediate \n    The number of times that a request for a table lock could be granted immediately. \n•Table_locks_waited \n    The number of times that a request for a table lock could not be granted immediately and a wait was needed. If this is high and you have performance problems, you should first optimize your queries, and then either split your table or tables or use replication. \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("•Table_locks_immediate \n    The number of times that a request for a table lock could be granted immediately. \n•Table_locks_waited \n    The number of times that a request for a table lock could not be granted immediately and a wait was needed. If this is high and you have performance problems, you should first optimize your queries, and then either split your table or tables or use replication. \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),s._v(" "),a("li",[s._v("Innodb : "),a("code",[s._v("show status like 'innodb_row_lock%'")]),s._v(" "),a("ul",[a("li",[a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code")]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"})]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code")]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"})]),s._v("查看InnoDB行锁争用情况")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("在学习锁的过程中，常用：set autocommit = 0; 来关闭自动提交，进而观察的状态。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("在学习锁的过程中，常用：set autocommit = 0; 来关闭自动提交，进而观察的状态。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_4-myisam-innodb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-myisam-innodb"}},[s._v("#")]),s._v(" 4. MyISAM & InnoDB")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("引擎")]),s._v(" "),a("th",[s._v("事务")]),s._v(" "),a("th",[s._v("锁机制")]),s._v(" "),a("th",[s._v("外键")]),s._v(" "),a("th",[s._v("并发性能")]),s._v(" "),a("th",[s._v("缓存")]),s._v(" "),a("th",[s._v("备份")]),s._v(" "),a("th",[s._v("系统表是否使用")]),s._v(" "),a("th",[s._v("引入GTID后的影响")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("MyISAM")]),s._v(" "),a("td",[s._v("不支持")]),s._v(" "),a("td",[s._v("表锁")]),s._v(" "),a("td",[s._v("不支持")]),s._v(" "),a("td",[s._v("低")]),s._v(" "),a("td",[s._v("索引")]),s._v(" "),a("td",[s._v("为了保持数据一致性，必须对表加读锁，影响业务写")]),s._v(" "),a("td",[s._v("使用")]),s._v(" "),a("td",[s._v("有问题(一个事务中同时使用事务引擎和非事务引擎)")])]),s._v(" "),a("tr",[a("td",[s._v("InnoDB")]),s._v(" "),a("td",[s._v("支持")]),s._v(" "),a("td",[s._v("行锁")]),s._v(" "),a("td",[s._v("支持")]),s._v(" "),a("td",[s._v("高")]),s._v(" "),a("td",[s._v("索引和数据")]),s._v(" "),a("td",[s._v("不需要锁表，不影响业务读写")]),s._v(" "),a("td",[s._v("使用")]),s._v(" "),a("td",[s._v("无问题")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("从MySQL5.5开始，默认存储引擎变为了InnoDB，在此之前默认引擎使用的是MyISAM.\n从MySQL8.0开始，系统表也将采用InnoDB，完全放弃MyISAM。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("MyISAM")]),s._v(" "),a("ul",[a("li",[s._v("MyISAM面临的主要问题\n"),a("ul",[a("li",[s._v("问题1：主从复制中断、主从数据不一致 ：由于MyISAM不支持事务，导致特别容易出现主备复制异常、主备数据不一致的情况")]),s._v(" "),a("li",[s._v("问题2: 进行备份时，无论是采用mysqldump进行的逻辑备份还是使用extrabackup进行的物理备份，为了保证MyISAM表的数据一致性，必须对表进行加锁，导致阻塞写入。这对于重建主从是经常出现的问题。")])])]),s._v(" "),a("li",[s._v("MyISAM表级锁:\n"),a("ul",[a("li",[s._v("模式：表共享读锁(Table Read Lock)、表独占写锁(Table Write Lock)")]),s._v(" "),a("li",[s._v("默认情况下，写锁比读锁具有更高的优先级，这正是 MyISAM 表不太适合于有大量更新操作和查询操作应用的原因。因为，大量的更新操作会造成查询操作很难获得读锁，从而可能永远阻塞。")]),s._v(" "),a("li",[s._v("在自动加锁的情况下，MyISAM 总是一次获得 SQL 语句所需要的全部锁，所以 MyISAM 表不会出现死锁。")])])])])]),s._v(" "),a("li",[a("p",[s._v("InnoDB")]),s._v(" "),a("ul",[a("li",[s._v("与 MyISAM 最大不同有两点：\n"),a("ol",[a("li",[s._v("支持事务")]),s._v(" "),a("li",[s._v("采用行级锁")])])])])]),s._v(" "),a("li",[a("p",[s._v("索引")]),s._v(" "),a("ul",[a("li",[s._v("MyISAM\n"),a("ul",[a("li",[s._v("MyISAM索引实现：MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址.")]),s._v(" "),a("li",[s._v("在MyISAM中，主索引和辅助索引辅助索引(Secondary Index, 即非主键索引)在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。")])])]),s._v(" "),a("li",[s._v("InnoDB\n"),a("ul",[a("li",[s._v("InnoDB 表是基于聚簇索引建立的。因此InnoDB 的索引能提供一种非常快速的主键查找性能。InnoDB 不会压缩索引。\n"),a("ul",[a("li",[s._v("聚集索引这种实现方式使得按主键的搜索十分高效，但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。")]),s._v(" "),a("li",[s._v("因为所有辅助索引都引用主索引(即，辅助索引也会包含主键列)，如果主键定义的比较大，其他索引也将很大，所以不建议使用过长的字段作为主键。另外，如果想在表上定义很多索引，则争取尽量把主键定义得小一些。")])])]),s._v(" "),a("li",[s._v("行锁\n"),a("ul",[a("li",[s._v("InnoDB的行锁是针对索引加的锁，不是针对记录加的锁。\n"),a("ul",[a("li",[s._v("这一点MySQL与Oracle不同，它们是通过在数据块中，对相应数据行加锁来实现的")])])]),s._v(" "),a("li",[s._v("InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，innoDB才使用行级锁，否则InnoDB将使用表锁。")])])]),s._v(" "),a("li",[s._v("主键\n"),a("ul",[a("li",[s._v("用非单调的字段作为主键在InnoDB中不是个好主意，因为InnoDB数据文件本身是一颗B+Tree，非单调的主键会造成在插入新记录时数据文件为了维持B+Tree的特性而频繁的分裂调整，十分低效，而使用自增字段作为主键则是一个很好的选择。")])])])])])])])]),s._v(" "),a("h4",{attrs:{id:"mysql-内存优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-内存优化"}},[s._v("#")]),s._v(" Mysql 内存优化")]),s._v(" "),a("p",[a("em",[s._v("注意：以下都是在MySQL目录下的my.ini文件中改写")])]),s._v(" "),a("ul",[a("li",[s._v("InnoDB内存优化\n"),a("ul",[a("li",[s._v("InnoDB用一块内存区域做I/O缓存池，该缓存池不仅用来缓存InnoDB的索引块，而且也用来缓存InnoDB的数据块。")])]),s._v(" "),a("ol",[a("li",[s._v("innodb_log_buffer_size\n"),a("ul",[a("li",[s._v("决定了InnoDB重做日志缓存的大小，可以避免InnoDB在事务提交前就执行不必要的日志写入磁盘操作。")])])]),s._v(" "),a("li",[s._v("Innodb_buffer_pool_size\n"),a("ul",[a("li",[s._v("决定了InnoDB存储引擎表数据和索引数据的最大缓存区大小。")])])])])]),s._v(" "),a("li",[s._v("MyISAM内存优化\n"),a("ul",[a("li",[s._v("MyISAM存储引擎使用key_buffer缓存索引模块，加速索引的读写速度。对于MyISAM表的数据块，mysql没有特别的缓存机制，完全依赖于操作系统的IO缓存。")])]),s._v(" "),a("ol",[a("li",[s._v("read_rnd_buffer_size\n"),a("ul",[a("li",[s._v("对于需要做排序的MyISAM表查询，如带有order by子句的sql，适当增加read_rnd_buffer_size的值，可以改善此类的sql性能。但需要注意的是read_rnd_buffer_size独占的，如果默认设置值太大，就会造成内存浪费。")])])]),s._v(" "),a("li",[s._v("key_buffer_size\n"),a("ul",[a("li",[s._v("key_buffer_size决定MyISAM索引块缓存分区的大小。直接影响到MyISAM表的存取效率。对于一般MyISAM数据库，建议1/4可用内存分配给key_buffer_size:")])])]),s._v(" "),a("li",[s._v("read_buffer_size\n"),a("ul",[a("li",[s._v("如果需要经常顺序扫描MyISAM表，可以通过增大read_buffer_size的值来改善性能。但需要注意的是read_buffer_size是每个seesion独占的，如果默认值设置太大，就会造成内存浪费。")])])])])]),s._v(" "),a("li",[s._v("调整MySQL参数并发相关的参数\n"),a("ol",[a("li",[s._v("调整max_connections: 提高并发连接")]),s._v(" "),a("li",[s._v("调整thread_cache_size\n"),a("ul",[a("li",[s._v("加快连接数据库的速度，MySQL会缓存一定数量的客户服务线程以备重用，通过参数thread_cache_size可控制mysql缓存客户端线程的数量。")])])]),s._v(" "),a("li",[s._v("innodb_lock_wait_timeout\n"),a("ul",[a("li",[s._v("控制InnoDB事务等待行锁的时间，对于快速处理的SQL语句，可以将行锁等待超时时间调大，以避免发生大的回滚操作。（技术文）")])])])])])])])}),[],!1,null,null,null);e.default=n.exports}}]);