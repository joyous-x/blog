<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Office 格式简析 - Crypto</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/img/favicon.ico">
    <meta name="description" content="Office 格式简析，查找 宏 以进行病毒检测">
    <meta name="keywords" content="博客,全栈,技术文档,学习,面试,Go,C/C++,Python,Markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/blog/assets/css/0.styles.648f69e5.css" as="style"><link rel="preload" href="/blog/assets/js/app.f4337a00.js" as="script"><link rel="preload" href="/blog/assets/js/3.0f18b0bf.js" as="script"><link rel="preload" href="/blog/assets/js/20.aab0c43c.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.adcd1511.js"><link rel="prefetch" href="/blog/assets/js/100.e4660ab3.js"><link rel="prefetch" href="/blog/assets/js/101.bbfb22ec.js"><link rel="prefetch" href="/blog/assets/js/102.1942f1b4.js"><link rel="prefetch" href="/blog/assets/js/103.ecb35c1e.js"><link rel="prefetch" href="/blog/assets/js/104.c6ed4a95.js"><link rel="prefetch" href="/blog/assets/js/105.e6d047b9.js"><link rel="prefetch" href="/blog/assets/js/106.33ac5f8d.js"><link rel="prefetch" href="/blog/assets/js/107.70c2c076.js"><link rel="prefetch" href="/blog/assets/js/108.eb9c9e8b.js"><link rel="prefetch" href="/blog/assets/js/109.6c538ed9.js"><link rel="prefetch" href="/blog/assets/js/11.40b77d67.js"><link rel="prefetch" href="/blog/assets/js/12.c5496082.js"><link rel="prefetch" href="/blog/assets/js/13.249e412a.js"><link rel="prefetch" href="/blog/assets/js/14.e3d8bc6f.js"><link rel="prefetch" href="/blog/assets/js/15.537928a1.js"><link rel="prefetch" href="/blog/assets/js/16.7c4a5214.js"><link rel="prefetch" href="/blog/assets/js/17.58785fa3.js"><link rel="prefetch" href="/blog/assets/js/18.957c42d0.js"><link rel="prefetch" href="/blog/assets/js/19.64a4196b.js"><link rel="prefetch" href="/blog/assets/js/2.f5d64578.js"><link rel="prefetch" href="/blog/assets/js/21.be7b643c.js"><link rel="prefetch" href="/blog/assets/js/22.c2d9415c.js"><link rel="prefetch" href="/blog/assets/js/23.f775726e.js"><link rel="prefetch" href="/blog/assets/js/24.df0e5784.js"><link rel="prefetch" href="/blog/assets/js/25.58069b0f.js"><link rel="prefetch" href="/blog/assets/js/26.7a52b220.js"><link rel="prefetch" href="/blog/assets/js/27.f1af15b4.js"><link rel="prefetch" href="/blog/assets/js/28.f0590cb5.js"><link rel="prefetch" href="/blog/assets/js/29.ffe5ea4d.js"><link rel="prefetch" href="/blog/assets/js/30.059ae8b1.js"><link rel="prefetch" href="/blog/assets/js/31.a1989db1.js"><link rel="prefetch" href="/blog/assets/js/32.bfd962fd.js"><link rel="prefetch" href="/blog/assets/js/33.4194be06.js"><link rel="prefetch" href="/blog/assets/js/34.e16f2d07.js"><link rel="prefetch" href="/blog/assets/js/35.0578cbda.js"><link rel="prefetch" href="/blog/assets/js/36.840b93e5.js"><link rel="prefetch" href="/blog/assets/js/37.bd41fd48.js"><link rel="prefetch" href="/blog/assets/js/38.8ac5f35a.js"><link rel="prefetch" href="/blog/assets/js/39.61c43fcd.js"><link rel="prefetch" href="/blog/assets/js/4.fbbca55c.js"><link rel="prefetch" href="/blog/assets/js/40.3e6b5c6d.js"><link rel="prefetch" href="/blog/assets/js/41.d89b866a.js"><link rel="prefetch" href="/blog/assets/js/42.fbec8fc8.js"><link rel="prefetch" href="/blog/assets/js/43.51f5f5b3.js"><link rel="prefetch" href="/blog/assets/js/44.2099516b.js"><link rel="prefetch" href="/blog/assets/js/45.6289bafd.js"><link rel="prefetch" href="/blog/assets/js/46.afe76916.js"><link rel="prefetch" href="/blog/assets/js/47.e06d16af.js"><link rel="prefetch" href="/blog/assets/js/48.d7fd8911.js"><link rel="prefetch" href="/blog/assets/js/49.4dcd4441.js"><link rel="prefetch" href="/blog/assets/js/5.56f2cf4e.js"><link rel="prefetch" href="/blog/assets/js/50.ca219ca4.js"><link rel="prefetch" href="/blog/assets/js/51.1c4a56e7.js"><link rel="prefetch" href="/blog/assets/js/52.f49df721.js"><link rel="prefetch" href="/blog/assets/js/53.599ce98f.js"><link rel="prefetch" href="/blog/assets/js/54.029ad282.js"><link rel="prefetch" href="/blog/assets/js/55.1389fd70.js"><link rel="prefetch" href="/blog/assets/js/56.13e5d9ed.js"><link rel="prefetch" href="/blog/assets/js/57.2b1170b4.js"><link rel="prefetch" href="/blog/assets/js/58.32719779.js"><link rel="prefetch" href="/blog/assets/js/59.6066f0fa.js"><link rel="prefetch" href="/blog/assets/js/6.b020662e.js"><link rel="prefetch" href="/blog/assets/js/60.d65280fe.js"><link rel="prefetch" href="/blog/assets/js/61.72f54a90.js"><link rel="prefetch" href="/blog/assets/js/62.30ad8d40.js"><link rel="prefetch" href="/blog/assets/js/63.def6c882.js"><link rel="prefetch" href="/blog/assets/js/64.8cf382a2.js"><link rel="prefetch" href="/blog/assets/js/65.d7fff0e8.js"><link rel="prefetch" href="/blog/assets/js/66.04689768.js"><link rel="prefetch" href="/blog/assets/js/67.8a3c2f78.js"><link rel="prefetch" href="/blog/assets/js/68.e4440e91.js"><link rel="prefetch" href="/blog/assets/js/69.703d7d9a.js"><link rel="prefetch" href="/blog/assets/js/7.d9fb3a7a.js"><link rel="prefetch" href="/blog/assets/js/70.af372ac1.js"><link rel="prefetch" href="/blog/assets/js/71.cca7b843.js"><link rel="prefetch" href="/blog/assets/js/72.f6779ac7.js"><link rel="prefetch" href="/blog/assets/js/73.ec50ceb2.js"><link rel="prefetch" href="/blog/assets/js/74.b699d401.js"><link rel="prefetch" href="/blog/assets/js/75.45598d4a.js"><link rel="prefetch" href="/blog/assets/js/76.c1c8e181.js"><link rel="prefetch" href="/blog/assets/js/77.eed69ec8.js"><link rel="prefetch" href="/blog/assets/js/78.e3d46634.js"><link rel="prefetch" href="/blog/assets/js/79.8a846051.js"><link rel="prefetch" href="/blog/assets/js/8.06ed2cd8.js"><link rel="prefetch" href="/blog/assets/js/80.f2011a9d.js"><link rel="prefetch" href="/blog/assets/js/81.1c07afc3.js"><link rel="prefetch" href="/blog/assets/js/82.2f9b0b0c.js"><link rel="prefetch" href="/blog/assets/js/83.4aa219b5.js"><link rel="prefetch" href="/blog/assets/js/84.e0f4c3ad.js"><link rel="prefetch" href="/blog/assets/js/85.1db0dcf4.js"><link rel="prefetch" href="/blog/assets/js/86.e9ea178f.js"><link rel="prefetch" href="/blog/assets/js/87.29211bcb.js"><link rel="prefetch" href="/blog/assets/js/88.b21427b5.js"><link rel="prefetch" href="/blog/assets/js/89.1e75d9f3.js"><link rel="prefetch" href="/blog/assets/js/9.d2289f70.js"><link rel="prefetch" href="/blog/assets/js/90.54054b84.js"><link rel="prefetch" href="/blog/assets/js/91.6e7e0a03.js"><link rel="prefetch" href="/blog/assets/js/92.c7bbfbeb.js"><link rel="prefetch" href="/blog/assets/js/93.5c0da2d2.js"><link rel="prefetch" href="/blog/assets/js/94.4fb52bba.js"><link rel="prefetch" href="/blog/assets/js/95.5efd98ca.js"><link rel="prefetch" href="/blog/assets/js/96.ed3f5494.js"><link rel="prefetch" href="/blog/assets/js/97.b07e4f85.js"><link rel="prefetch" href="/blog/assets/js/98.b3437cc4.js"><link rel="prefetch" href="/blog/assets/js/99.3e5df003.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.648f69e5.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open no-sidebar have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/web_logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><a href="/blog/blog/" class="link-title router-link-active">Blog</a> <span class="title" style="display:none;">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/lang/" class="nav-link">Language</a></li></ul></li><li class="dropdown-item"><h4>设计</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/design/" class="nav-link">Design</a></li></ul></li><li class="dropdown-item"><h4>网络</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/network/" class="nav-link">Network</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/database/" class="nav-link">Database</a></li></ul></li><li class="dropdown-item"><h4>平台</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/platform/" class="nav-link">Platform</a></li></ul></li><li class="dropdown-item"><h4>技能</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/skills/##Devops" class="nav-link">Devops</a></li><li class="dropdown-subitem"><a href="/blog/blog/skills/##Ai" class="nav-link">AI</a></li></ul></li><li class="dropdown-item"><h4>应用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/utilization/" class="nav-link">Utilization</a></li></ul></li><li class="dropdown-item"><h4>杂项</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/utility/##Rnote" class="nav-link">ReadNote</a></li><li class="dropdown-subitem"><a href="/blog/blog/utility/##Tools" class="nav-link">Tools</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/more/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/blog/more/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><h4>收藏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/more/favorites/" class="nav-link">favorites</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/index/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/index/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/index/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/index/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/joyous-x/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.png"> <div class="blogger-info"><h3>Jiao</h3> <span>知行合一</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><a href="/blog/blog/" class="link-title router-link-active">Blog</a> <span class="title" style="display:none;">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>语言</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/lang/" class="nav-link">Language</a></li></ul></li><li class="dropdown-item"><h4>设计</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/design/" class="nav-link">Design</a></li></ul></li><li class="dropdown-item"><h4>网络</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/network/" class="nav-link">Network</a></li></ul></li><li class="dropdown-item"><h4>数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/database/" class="nav-link">Database</a></li></ul></li><li class="dropdown-item"><h4>平台</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/platform/" class="nav-link">Platform</a></li></ul></li><li class="dropdown-item"><h4>技能</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/skills/##Devops" class="nav-link">Devops</a></li><li class="dropdown-subitem"><a href="/blog/blog/skills/##Ai" class="nav-link">AI</a></li></ul></li><li class="dropdown-item"><h4>应用</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/utilization/" class="nav-link">Utilization</a></li></ul></li><li class="dropdown-item"><h4>杂项</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/blog/utility/##Rnote" class="nav-link">ReadNote</a></li><li class="dropdown-subitem"><a href="/blog/blog/utility/##Tools" class="nav-link">Tools</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/more/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/blog/more/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><h4>收藏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/more/favorites/" class="nav-link">favorites</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/blog/index/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/index/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/blog/index/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/blog/index/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/joyous-x/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/blog/categories/?category=blog" title="分类" data-v-1baff76c>blog</a></li><li data-v-1baff76c><a href="/blog/categories/?category=skills" title="分类" data-v-1baff76c>skills</a></li><li data-v-1baff76c><a href="/blog/categories/?category=office" title="分类" data-v-1baff76c>office</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/joyous-x" target="_blank" title="作者" class="beLink" data-v-1baff76c>Jiao</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2021-06-18</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Office 格式简析 - Crypto<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h1 id="ms-offcrypto"><a href="#ms-offcrypto" class="header-anchor">#</a> MS-OFFCRYPTO</h1> <p>MS-OFFCRYPTO 只对 windows office 生效，所以有一些常见的规则约定：</p> <ul><li>ole 中用于指定 storages 和 streams 位置的路径使用 backslash() 作为分隔符</li> <li>以 backslash() 开始的路径是指 ole compound file 的 root storage</li> <li>Byte Ordering 默认是 little-endian</li></ul> <h2 id="一、data-spaces"><a href="#一、data-spaces" class="header-anchor">#</a> 一、Data Spaces</h2> <p>data spaces 结构描述了一种存储经过某种方式转换(transformed)后的 OLE 复合文件的一致性方法。所以，该结构需要存储受保护的内容(protected content)和应用于内容的转换信息(information about the transforms)。例如，下文的 IRMDS 和 Encryption 等都是基于 data spaces 结构进行的。</p> <p>data spaces 结构允许客户端应用程序描述一个或多个任意转换。每个变换表示要对原始文档内容中的一组 storages 或 streams 执行的单个任意操作。一个或多个转换可以被组合到一个 data space 的定义中，然后这个定义可以被应用到存在于 data space map 中的原始文档的任意 storages 或 streams 中。</p> <h3 id="information-rights-management-data-space-irmds"><a href="#information-rights-management-data-space-irmds" class="header-anchor">#</a> Information Rights Management Data Space(IRMDS)</h3> <p>IRMDS 主要应用于强化文档的权限管理策略。当对使用了权限管理策略的文档进行<strong>读、写、创建</strong>操作时，需要使用到 IRMDS structure。</p> <p>IRMDS 可以被应用于以下两种类型的文档:</p> <ul><li>Office binary documents</li> <li>ECMA-376 documents</li></ul> <p><img src="/blog/assets/img/IRMDS.097d215e.png" alt="IRMDS"></p> <p><em>ECMA, European Computer Manufacturers Association；</em> <em>ECMA376 协议代指 Office Open XML 格式</em></p> <p>具体的差别如下：</p> <h4 id="_0x06dataspaces-dataspacemap-stream"><a href="#_0x06dataspaces-dataspacemap-stream" class="header-anchor">#</a> &quot;\0x06DataSpaces\DataSpaceMap&quot; Stream</h4> <ol><li>Office binary document</li></ol> <ul><li>至少有一个 DataSpaceMapEntry 结构</li> <li>必须有一个 DataSpaceMapEntry 结构的 DataSpaceName 字段为 &quot;\009DRMDataSpace&quot;
<ul><li>此结构中，有且只有一个 ReferenceComponents 结构，表示一个名为 &quot;\009DRMContent&quot; 的 stream</li></ul></li> <li>第二种 DataSpaceMapEntry 结构的 DataSpaceName 字段必须为 &quot;\009LZXDRMDataSpace&quot;
<ul><li>此结构中，有且只有一个 ReferenceComponents 结构，表示一个名为 &quot;\009DRMViewerContent&quot; 的 stream</li></ul></li></ul> <ol start="2"><li>ECMA-376 document</li></ol> <ul><li>有且只有一个 DataSpaceMapEntry 结构，这个结构的 DataSpaceName 字段为 &quot;DRMEncryptedDataSpace&quot;
<ul><li>此结构中，有且只有一个 ReferenceComponents 结构，表示一个名为 &quot;EncryptedPackage&quot; 的 stream</li></ul></li></ul> <h4 id="_0x06dataspaces-dataspaceinfo-storage"><a href="#_0x06dataspaces-dataspaceinfo-storage" class="header-anchor">#</a> &quot;\0x06DataSpaces\DataSpaceInfo&quot; Storage</h4> <ol><li>Office binary document</li></ol> <ul><li>必须包含一个名为 &quot;\009DRMDataSpace&quot; 的 stream
<ul><li>流中必须包含一个 DataSpaceDefinition 结构，此结构有且仅有一个名为 &quot;\009DRMTransform&quot; 的 TransformReferences</li></ul></li> <li>可能会包含一个名为 &quot;\009LZXDRMDataSpace&quot; 的 stream
<ul><li>流中必须包含一个这样的 DataSpaceDefinition 结构：有且仅有两个 TransformReferences 条目，&quot;\009DRMTransform&quot; 和 &quot;\009LZXTransform&quot;</li></ul></li></ul> <ol start="2"><li>ECMA-376 document</li></ol> <ul><li>必须包含一个名为 &quot;DRMEncryptedDataSpace&quot; 的 stream
<ul><li>流中必须含有一个 DataSpaceDefinition 结构，此结构有且仅有一个名为 &quot;DRMEncryptedTransform&quot; 的 TransformReferences 条目</li></ul></li></ul> <h4 id="_0x06dataspaces-transforminfo-storage"><a href="#_0x06dataspaces-transforminfo-storage" class="header-anchor">#</a> &quot;\0x06DataSpaces\TransformInfo&quot; Storage</h4> <ol><li>Office binary document</li></ol> <ul><li>必须包含一个名为 &quot;\009DRMTransform&quot; 的 storage，其下必须包含一个名为 &quot;\006Primary&quot; 的 stream (完整路径为：&quot;0x09DRMTransform\0x06Primary&quot;)。
<ul><li>此 stream 必定包含 IRMDSTransformInfo 结构，其内容如下：
<ul><li>TransformInfoHeader.TransformID MUST be &quot;{C73DFACD-061F-43B0-8B64-0C620D2A8B50}&quot;</li> <li>TransformInfoHeader.TransformName MUST be &quot;Microsoft.Metadata.DRMTransform&quot;</li></ul></li> <li>&quot;\009DRMTransform&quot; storage 同时必须包含一个或多个 end-user license streams</li></ul></li> <li>可能包含一个名为 &quot;\009LZXTransform&quot; 的 storage。如果此 storage 存在，则其下必须存在一个名为 &quot;\006Primary&quot; 的 stream
<ul><li>此 stream 必定包含 TransformInfoHeader 结构，其内容如下：
<ul><li>TransformType MUST be 0x00000001</li> <li>TransformID MUST be &quot;{86DE7F2B-DDCE-486d-B016-405BBE82B8BC}&quot;</li> <li>TransformName MUST be &quot;Microsoft.Metadata.CompressionTransform&quot;</li></ul></li></ul></li></ul> <ol start="2"><li>ECMA-376 document</li></ol> <ul><li>必须包含一个名为 &quot;DRMEncryptedTransform&quot; 的 storage，此 storage 下必须包含一个名为 &quot;\006Primary&quot; 的 stream
<ul><li>此 stream 必定包含 IRMDSTransformInfo 结构，其内容如下：
<ul><li>TransformInfoHeader.TransformID MUST be &quot;&quot;{C73DFACD-061F-43B0-8B64-0C620D2A8B50}&quot;</li> <li>TransformInfoHeader.TransformName MUST be &quot;Microsoft.Metadata.DRMTransform&quot;</li></ul></li> <li>&quot;DRMEncryptedTransform&quot; storage 同时必须包含一个或多个 end-user license streams</li></ul></li></ul> <p>上文中涉及到的 End-User License Stream，其中包含了缓存的 licenses 信息。这些 end-user license stream 的命名必须以 &quot;EUL-&quot; 为前缀，为：<code>&quot;EUL-&quot; + &quot;一个 base-32-encoded 的GUID&quot;</code>。</p> <h3 id="protected-content-stream"><a href="#protected-content-stream" class="header-anchor">#</a> Protected Content Stream</h3> <p>protected content stream 必须是在 root storage 中。如果原始文档是 ECMA-376 时，流的名字必定是 &quot;EncryptedPackage&quot;；原始文档是任意其他格式时, 流的名字一定是 &quot;\0x09DRMContent&quot;。</p> <p>而这个受保护的流由: <code>Length(8 bytes) + Contents(variable)</code> 组成。</p> <p>其中 <code>Contents</code> 是使用对称密钥，AES-128 算法, 16-byte block size, electronic codebook (ECB) mode 以及 全 0 的初始向量进行加解密的。</p> <h3 id="encryption-and-obfuscation"><a href="#encryption-and-obfuscation" class="header-anchor">#</a> Encryption and Obfuscation</h3> <p>应用于 ms-office 的加密和混淆的共有四种不同的技术：</p> <ol><li>XOR Obfuscation</li></ol> <ul><li>对象：[MS-XLS] and [MS-DOC]</li> <li>方法：对 Office Binary Document 的部分(storage 或 stream)执行就地混淆</li> <li>细节：包含两种方法：Method 1 和 Method 2
<ul><li>Method 1 应用于 Excel Binary File Format (.xls) 的 structures 和 procedures</li> <li>Method 2 应用于 Word Binary File Format (.doc) 的 structures 和 procedures</li></ul></li></ul> <ol start="2"><li>40-bit RC4 Encryption</li></ol> <ul><li>对象：[MS-XLS] and [MS-DOC]</li> <li>方法：对 Office Binary Document 的部分(storage 或 stream)执行就地加密</li> <li>细节：
<ul><li>算法中的 hash 函数为 MD5</li> <li>除非特殊说明，否则，最大密码长度为：255 Unicode characters</li></ul></li></ul> <ol start="3"><li>RC4 CryptoAPI Encryption</li></ol> <ul><li>对象：[MS-XLS], [MS-DOC], and [MS-PPT]</li> <li>方法：可能会有一个 Encrypted Summary Stream 被创建，也能对其他 stream 执行就地加密</li> <li>细节：
<ul><li>除非特殊说明，否则，最大密码长度为：255 Unicode characters</li> <li>SHA-1 hash 是 160 bits, 而 RC4 的 key 最大长度是 128 bits; 因此, key 必定少于或等于 128 bits。
<ul><li>如果 key 只有 40 bits，说明这是一个非常老的版本，此时加密算法必须创建一个由 Hfinal 的前 40 bits 和 88 bits 的 0 拼接而成的 128-bit 的 key</li></ul></li></ul></li></ul> <ol start="4"><li>ECMA-376 Document Encryption</li></ol> <ul><li>对象：[ECMA-376]</li> <li>方法：利用 data spaces 功能将 [ECMA-376] 文档加密成了 ole 中的一个 stream</li> <li>细节：一共有三种方法，
<ul><li>Standard encryption:
<ul><li>利用二进制(binary)类型的 EncryptionInfo 结构存储加密信息，使用 AES 作为加密算法，SHA-1 作为散列(hash)算法</li></ul></li> <li>Agile encryption:
<ul><li>利用 XML 存放加密信息。加密和散列算法在结构中指定，可以使用主机支持的任何加密算法。还支持数据完整性校验。</li></ul></li> <li>Extensible encryption:
<ul><li>此方法使用可扩展的机制来允许使用任意的第三方加密扩展模块</li></ul></li></ul></li></ul> <p><em>注：ECMA-376 和 RC4 CryptoAPI 加密算法都使用到了 EncryptionHeader 结构</em></p> <h4 id="ecma-376-document-encryption"><a href="#ecma-376-document-encryption" class="header-anchor">#</a> ECMA-376 Document Encryption</h4> <ol><li>&quot;\0x06DataSpaces\DataSpaceMap&quot; Stream</li></ol> <ul><li>必须包含一个 DataSpaceMap 结构，其中有且只有一个 DataSpaceMapEntry 结构
<ul><li>此结构的 DataSpaceName 字段为 &quot;StrongEncryptionDataSpace&quot;</li> <li>此结构中，有且只有一个 ReferenceComponents 结构，表示一个名为 &quot;EncryptedPackage&quot; 的 stream</li></ul></li></ul> <ol start="2"><li>&quot;\0x06DataSpaces\TransformInfo&quot; Storage</li></ol> <ul><li>必须包含一个名为 &quot;StrongEncryptionTransform&quot; 的 storage，其下必须包含一个名为 &quot;\006Primary&quot; 的 stream
<ul><li>这个流必须包含一个 IRMDSTransformInfo 结构，其内容如下：
<ul><li>TransformInfoHeader.TransformType MUST be 0x00000001</li> <li>TransformInfoHeader.TransformID MUST be &quot;{FF9A3F03-56EF-4613-BDD5-5A41C1D07246}&quot;</li> <li>TransformInfoHeader.TransformName MUST be &quot;Microsoft.Container.EncryptionTransform&quot;.</li></ul></li> <li>紧跟着 IRMDSTransformInfo 的是一个 EncryptionTransformInfo 结构
<ul><li>如果 EncryptionInfo 和 EncryptionTransformInfo 中的算法不一致时，认为 EncryptionInfo 中的更加权威。</li> <li>如果使用 agile encryption 时，EncryptionTransformInfo 的 EncryptionName 字段必须为空字符串(0x00000000)</li></ul></li></ul></li></ul> <ol start="3"><li>&quot;\EncryptedPackage&quot; Stream</li></ol> <ul><li>是一个加密的 stream，它包含了完整的(压缩后的) ECMA376 原文件
<ul><li>由 StreamSize(8 bytes) + EncryptedData(variable) 组成</li> <li>StreamSize 指明 EncryptedData 的字节数。另外，StreamSize 的大小实际上可能会与流的大小有出入，这依赖于所用加密算法的 block size</li></ul></li></ul> <ol start="4"><li>&quot;\EncryptionInfo&quot; Stream</li></ol> <ul><li>Standard Encryption
<ul><li>包含用于初始化用于加密 &quot;\EncryptedPackage&quot; 流的密码学详细信息</li></ul></li> <li>Agile Encryption
<ul><li>包含用于初始化用于加密 &quot;\EncryptedPackage&quot; 流的密码学详细信息</li></ul></li> <li>Extensible Encryption
<ul><li>ECMA-376 文档可以选择使用用户提供的自定义（可扩展）加密模块。当使用可扩展加密时，\EncryptionInfo 流的结构描述不同于标准模式，详细可以参考文档[MS-OFFCRYPTO]</li></ul></li></ul> <h4 id="office-binary-document-encryption"><a href="#office-binary-document-encryption" class="header-anchor">#</a> Office Binary Document Encryption</h4> <p>XOR、RC4 以及 RC4 CryptoAPI 都可以应用于 Office Binary Document 文件。</p> <p>详细信息见本文档关于 [xls]、[doc]、 [ppt] 的描述。</p> <h3 id="write-protection"><a href="#write-protection" class="header-anchor">#</a> Write Protection</h3> <h4 id="ecma-376-document-write-protection"><a href="#ecma-376-document-write-protection" class="header-anchor">#</a> ECMA-376 Document Write Protection</h4> <p>ECMA-376 文档的 write protection 在 [ECMA-376] 文档的 Part 4 中的 Sections 2.15.1.28, 2.15.1.94, 3.2.12, 和 4.3.1.17 中有详细描述。</p> <h4 id="binary-document-write-protection"><a href="#binary-document-write-protection" class="header-anchor">#</a> Binary Document Write Protection</h4> <p>二进制类型 office 文档的基于 password 的 Write Protection 根据文件格式的不同具有不同的细节, 大致如下：</p> <ul><li>.xls
<ul><li>密码被转换成了一个 16-bit 的 password verifier, 并将其依 [MS-XLS] 文档进行存储, 同时，文档会被加密。如果用户未提供加密密码，会使用一个固定密码。
<ul><li>默认密码是：<code>\x56\x65\x6C\x76\x65\x74\x53\x77\x65\x61\x74\x73\x68\x6F\x70</code>(也可以表示为：<code>VelvetSweatshop</code>)</li></ul></li> <li>使用 Write Protection 的同时，依然可以按照 Encryption 的描述进行加密</li> <li>详细内容参考 [MS-XLS] section 2.2.9</li></ul></li> <li>.doc
<ul><li>密码以明文形式存储，并且文档内容未被加密。</li> <li>详细内容参考 [MS-DOC] section 2.9.276</li></ul></li> <li>.ppt
<ul><li>密码以明文形式存储，并且文档可以被加密。如果文档被加密，但用户未提供加密密码时，会使用一个固定密码。
<ul><li>默认密码是：<code>\x2f\x30\x31\x48\x61\x6e\x6e\x65\x73\x20\x52\x75\x65\x73\x63\x68\x65\x72\x2f\x30\x31</code>(也可以表示为：<code>/01Hannes Ruescher/01</code>)</li></ul></li> <li>使用 Write Protection 的同时，不应该(SHOULD NOT)再按照 Encryption 中描述的算法进行加密</li> <li>详细内容参考 [MS-PPT] section 2.4.7</li></ul></li></ul> <p>另外还有 ISO Write Protection Method， 其旨在与 ISO/IEC 29500 兼容</p> <h3 id="digital-signatures"><a href="#digital-signatures" class="header-anchor">#</a> Digital Signatures</h3> <h4 id="ecma-376-document-digital-signatures"><a href="#ecma-376-document-digital-signatures" class="header-anchor">#</a> ECMA-376 Document Digital Signatures</h4> <p>用于 ECMA-376 documents 的 xmldsig 数字签名 和 用于 Office binary documents 的 xmldsig 数字签名非常相似。详细内容参考 [ECMA-376] Part 2 Section 12.2.4。</p> <h4 id="binary-document-digital-signatures"><a href="#binary-document-digital-signatures" class="header-anchor">#</a> Binary Document Digital Signatures</h4> <p>二进制类型 office 文档可以使用下述方法中的任意一种进行签名：</p> <ol><li>CryptoAPI digital signature
<ul><li>以二进制形式存储在 _signatures storage 中</li> <li>详细内容参考 [MS-OFFCRYPTO] Section 2.5.1</li></ul></li> <li>xmldsig digital signature</li></ol> <ul><li>以 XML-Signature 语法和处理方式(详见[XMLDSig])存储在 _xmlsignatures storage 中</li> <li>详细内容参考 [MS-OFFCRYPTO] Section 2.5.2</li></ul> <h2 id="二、xls"><a href="#二、xls" class="header-anchor">#</a> 二、XLS</h2> <p>这里主要关注 Encryption。</p> <h3 id="_2-1-password-verifier-algorithm"><a href="#_2-1-password-verifier-algorithm" class="header-anchor">#</a> 2.1 Password Verifier Algorithm</h3> <p>一些 records (Password, FileSharing, Prot4RevPass, FeatProtection, 和 FilePass) 会利用 password verifier 来锁定或解锁对 workbook 部分内容的查看或编辑。这个 password verifier 的设计主要是为了防止意外编辑，而不是安全特性。</p> <p><strong>It is possible to remove the passwords by removing the records containing the verifier values.</strong></p> <p>这个 verifier 的值由两个阶段计算:</p> <ul><li>将 Unicode 的 password 转换为当前系统的 ANSI 字符编码
<ul><li>任何不能被转换为 ANSI 字符编码的 Unicode 字符用 0x3F 替换。</li> <li>这个替换动作在验证 hash 时将生成正数哈希值匹配。在某些语言环境中，这些字符可能是日常字符集的重要组成部分。</li></ul></li> <li>使用 [MS-OFFCRYPTO] 中指定的 XOR obfuscation 算法(Binary Document Password Verifier Derivation Method 1)计算出16-bit 的 password verifier 值</li></ul> <h4 id="password-record"><a href="#password-record" class="header-anchor">#</a> Password record</h4> <p>Password record 为 sheet or workbook 指定了 password verifier。如果 record 结构中的 wPassword 值为 0，则表示没有密码。</p> <p>如果此 record 存在于 Globals Substream, 那么它是整个 workbook 的密码. 如果此 record 存在于 worksheet substream, chart sheet substream, macro sheet substream, or dialog sheet substream, 那么它仅仅适用于那个 sheet。</p> <p>此外，workbook 中必定存在此 record，而 sheet 则当且仅当有密码时才存在此 record。</p> <h3 id="_2-2-encryption-password-to-open"><a href="#_2-2-encryption-password-to-open" class="header-anchor">#</a> 2.2 Encryption (Password to Open)</h3> <p>其 obfuscation or encryption 信息存放于 workbook 流的 FilePass Record 中。</p> <p>如果使用的是 RC4 CryptoAPI 加密方式的话，某些 storages 和 streams 被存储在 Encryption Stream(详见 [MS-OFFCRYPTO] section 2.3.5.3)。这些 storages 和 streams 是否被加密等信息见下表(<a href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-xls/0f2ea0a1-9fc8-468d-97aa-9d333b72d106" target="_blank" rel="noopener noreferrer">reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)：</p> <ul><li><img src="/blog/assets/img/xls_rc4_cryptoapi.561a3ae9.png" alt="xls_rc4_cryptoapi"></li></ul> <p>其中带 (*) 标记的，表示这个 stream 或者 storage 中有 stream 包含 BIFF records 结构。当混淆或加密这些流中的 BIFF 记录时，有以下内容需要注意：</p> <ul><li>record type 和 record size 一定不得混淆或加密。</li> <li>以下这些 record 一定不能被混淆或加密：
<ul><li>BOF、FilePass、UsrExcl、FileLock、InterfaceHdr、RRDInfo 和 RRDHead</li></ul></li> <li>BoundSheet8 record 的 lbPlyPos 字段一定不能被加密或混淆</li></ul> <p><em>注意：上图可以看出，不止 Workbook Stream 可以包含 BIFF，User Names Stream、Revision Stream 也可以</em></p> <p>其中带 (**) 标记的，表示这个流当且仅当 EncryptionHeader.flags 的 0x08 bit 为 0 时，必须按照指定方式加密。(EncryptionHeader 见 [MS-OFFCRYPTO] section 2.3.5.1)。</p> <p>在使用 RC4、RC4 CAPI 算法加密时，需要以 1024-byte 的块来进行。从每个 BIFF record stream 的第一个字节开始，block number 置为 0，后续每 1024-byte 增加 1。</p> <h3 id="_2-3-xorarrayindex"><a href="#_2-3-xorarrayindex" class="header-anchor">#</a> 2.3 XorArrayIndex</h3> <p>当使用了 XOR 算法时，XorArrayIndex 的值的计算方法：<code>XorArrayIndex = (WorkbookStreamOffset + Data.Length) % 16</code></p> <p>上文中的变量 WorkbookStreamOffset 是在 record 中的每个字节在 Workbook stream 中的偏移。在写入过程中此变量会每字节递增，所以计算出首字节的 XorArrayIndex 后，即可通过递增得到后续字节的 index 值。</p> <p><em>Reference : <a href="https://social.msdn.microsoft.com/Forums/en-US/3dadbed3-0e68-4f11-8b43-3a2328d9ebd5/xls-xor-data-transformation-method-1?forum=os_binaryfile" target="_blank" rel="noopener noreferrer">XLS XOR Data Transformation Method 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <p>此外，用于 XOR 算法的密码长度不能超过15个字符。</p> <h2 id="三、doc"><a href="#三、doc" class="header-anchor">#</a> 三、DOC</h2> <h3 id="_3-1-encryption-and-obfuscation-password-to-open"><a href="#_3-1-encryption-and-obfuscation-password-to-open" class="header-anchor">#</a> 3.1 Encryption and Obfuscation (Password to Open)</h3> <p>二进制格式的 word 文件可以通过以下三种方式进行密码保护：XOR obfuscation、 RC4 encryption 以及  RC4 CryptoAPI encryption。</p> <p>当 FibBase.fEncrypted 和 FibBase.fObfuscated 都为 1 时, 文件被使用 XOR obfuscation 方式进行了混淆。</p> <p>当 FibBase.fEncrypted 和 FibBase.fObfuscated 都为 0 时, 文件被使用 XOR obfuscation 或 RC4 encryption 方式进行了加密。此时 EncryptionHeader 结构被存放在 Table stream 的头部 FibBase.lKey 个字节中。而具体使用哪种加密方式，则由 EncryptionHeader.EncryptionVersionInfo 结构决定。</p> <p>其中，Table stream 可以是 1Table 或 0Table，判定方法如下：</p> <ul><li>当 Fib.base.fWhichTblStm == 1 时，为 1Table stream</li> <li>当 Fib.base.fWhichTblStm == 0 时，为 0Table stream</li></ul> <p>另外，如果文档使用了 obfuscation 或 encryption 时, ObjectPool storage, Macros storage, Custom XML Data storage, XML Signatures storage, 和 Signatures stream 必定不能被加密或混淆。</p> <h4 id="xor-obfuscation"><a href="#xor-obfuscation" class="header-anchor">#</a> XOR Obfuscation</h4> <p>文档的 WordDocument stream、Table stream 以及 Data stream 必须使用 [MS-OFFCRYPTO] 中的 XOR Data Transformation Method 2 进行混淆，所有其他的 streams 和 storages 必须不能(MUST NOT)被混淆。另外，用于密码验证的 password verifier 必定存储在 FibBase.lKey 中。</p> <p>根据 [[MS-DOC] 2.2.6.1 XOR Obfuscation] 的说明，对 WordDocument stream 转换必须从流的第一个字节开始进行，但最初的 68 bytes 必须用原始的未转换的值。</p> <p>此外，用于 XOR 算法的密码长度不能超过15个字符。所以，需要将 unicode 的密码转换成 single-byte 字符，这里有以下两种方式：</p> <ul><li>使用 language code identifier (LCID) 将 unicode 转换为 ANSI 并截断</li> <li>对每个 unicode 字符，如果低字节为 0x00，则拷贝高字节到 single-byte; 否则，拷贝低字节到 single-byte。对结果进行截断，只保留 15 个字符</li></ul> <p>对于写操作来说，应该使用第二种方式。不过，如果是读文件的话，应当尝试以上两种方式，任意一种能够匹配即可认为密码正确。</p> <h4 id="office-binary-document-rc4-encryption"><a href="#office-binary-document-rc4-encryption" class="header-anchor">#</a> Office Binary Document RC4 Encryption</h4> <p>Table stream 的头部 FibBase.lKey 个字节中以未加密未混淆的方式存储了 EncryptionHeader 结构。Table stream 的剩余部分, WordDocument stream 的超出最初的 68 bytes 的部分, 以及 Data stream 的全部，必须被加密。所有其他的 streams 和 storages 必须不能(MUST NOT)被加密。</p> <p>被加密的三个流的数据必须(MUST)以 512-byte 的 blocks 的形式被加密。在流的起始位置，block number 必须被设置为 0，在每个 512-byte 边界处递增。注意，加密算法必须在流的第一个字节开始被执行，尽管一些字节是以未加密的形式被写入文件的。</p> <h4 id="office-binary-document-rc4-cryptoapi-encryption"><a href="#office-binary-document-rc4-cryptoapi-encryption" class="header-anchor">#</a> Office Binary Document RC4 CryptoAPI Encryption</h4> <p>Table stream 的头部 FibBase.lKey 个字节中以未加密未混淆的方式存储了 EncryptionHeader 结构。Table stream 的剩余部分, WordDocument stream 的超出最初的 68 bytes 的部分, 以及 Data stream 的全部，必须被加密。</p> <p>被加密的三个流的数据必须(MUST)以 512-byte 的 blocks 的形式被加密。在流的起始位置，block number 必须被设置为 0，在每个 512-byte 边界处递增。注意，加密算法必须在流的第一个字节开始被执行，尽管一些字节是以未加密的形式被写入文件的。</p> <p>此外，ObjectPool storage 必定不会出现。如果文件包含有 OLE objects 的话，用于 OLE objects 的 storage objects 必定(像 sprmCPicLocation 描述的那样)被存储在 Data stream 中。</p> <p>如果 EncryptionHeader.Flags 中的 fDocProps 被置位，那么 Encryption Stream 必定存在，Summary Information stream 必定不存在，一个被用作占位符的 Document Summary Information stream 必定存在。这些信息在 [MS-OFFCRYPTO] section 2.3.5.4 中有详细描述。</p> <p>如果 EncryptionHeader.Flags 中的 fDocProps 没被置位，那么 Document Summary Information stream 和 Summary Information stream 必定没有被加密。</p> <p>所有其他的 streams 和 storages 必须不能(MUST NOT)被加密。</p> <p>相关名词说明：</p> <ul><li>ObjectPool storage
<ul><li>包含多个用于 embedded OLE objects 的 storages，storages 中的每一个都一定包含一个名为 &quot;\003ObjInfo&quot; 的流，其中有一个用于描述 embedded OLE objects 的 ODT 结构</li></ul></li> <li>OLE object
<ul><li>支持 Object Linking and Embedding (OLE) 协议的对象</li></ul></li> <li>Encryption Stream
<ul><li>一个名为 encryption 的 stream</li> <li><em>当以下两个条件同时满足时，它必定存在，反之，当它们不能同时满足时，这个 stream 必定不会(MUST NOT)出现</em>：
<ol><li>文档被使用 Office Binary Document RC4 CryptoAPI Encryption 方法加密</li> <li>EncryptionHeader.Flags 中的 fDocProps 被置位</li></ol></li></ul></li></ul> <h2 id="四、ppt"><a href="#四、ppt" class="header-anchor">#</a> 四、PPT</h2> <p>只支持 RC4 CryptoAPI 加密方式。PPT 的加密信息存储在 CryptSession10Container record 中</p> <p>对于加密的 ppt 文档，必定满足以下条件：</p> <ul><li>Current User Stream
<ul><li>必定不能被加密</li> <li>CurrentUserAtom record 的 headerToken 字段应该为 0xF3D1C4DF
<ul><li>注意 PowerPoint 2002 会使用 0xE391C05F 来标记是否加密</li> <li>无论如何，当文档被加密时，UserEditAtom.encryptSessionPersistIdRef 一定存在并且不为 0 (PersistIdRef 为 0 时表示空引用)</li></ul></li></ul></li> <li>PowerPoint Document Stream
<ul><li>UserEditAtom record 和 PersistDirectoryAtom record 必定不能被加密</li> <li>CryptSession10Container record 的 rh 字段必定不能被加密</li> <li>CryptSession10Container record 的其他字段被按照 [MSOFFCRYPTO] section 2.3.5.1 进行了解释</li> <li>stream 的其它部分必定被加密</li> <li>stream 必定有且只有一个 UserEditAtom record</li> <li>UserEditAtom record 的 encryptSessionPersistIdRef 字段必定存在，它指向一个含有 CryptSession10Container record 的 persist object.
<ul><li>PowerPoint 97 and PowerPoint 2000 会忽略 UserEditAtom.encryptSessionPersistIdRef 字段，因为他们不支持文档的 opening 或 creating 加密</li></ul></li></ul></li> <li>Pictures Stream
<ul><li>如果存在的话，必定被加密</li></ul></li> <li>Summary Info Stream 和 Document Summary Info Stream
<ul><li>CryptSession10Container.data.EncryptionHeader.Flags 的 fDocProps == 0：
<ul><li>Summary Info Stream (名为 &quot;\005SummaryInformation&quot;)必定不存在</li> <li>Encrypted Summary Info Stream (名为 &quot;EncryptedSummary&quot;)必定存在</li> <li>Document Summary Info Stream (名为 &quot;\005DocumentSummaryInformation&quot;)应该存在，但是空的</li></ul></li> <li>CryptSession10Container.data.EncryptionHeader.Flags 的 fDocProps == 1：
<ul><li>Summary Info Stream 和 Document Summary Info Stream 必定没被加密</li></ul></li></ul></li></ul> <p>解密 encrypted document 的被解密部分，需要依照下面的规则：</p> <ul><li>For each block number the derived encryption key MUST be generated from the password hash and the block number as specified in [MS-OFFCRYPTO] section 2.3.5.2.</li></ul> <p>PowerPoint Document Stream 中的 persist object 依照下述规则被加密：</p> <ul><li>对于一个 persist object, 用于 derived encryption key 的 block number 就是 persist object 的 identifier</li> <li>用于 persist object 的 derived encryption key 必须通过 password hash 和 persist object 的 identifier 生成</li> <li>对于一个 persist object, 必须使用 derived encryption key 进行解密的字节由下述指定：
<ul><li>在 PowerPoint Document Stream section 中描述的 persist object 的文件偏移</li> <li>length in bytes == 8 + (文件偏移处的) RecordHeader 的 recLen 字段</li></ul></li> <li>解密后，字节长度范围符合 [MS-OFFCRYPTO] 文档规定</li></ul> <p>Pictures Stream 中的 picture (也就是说，OfficeArtBStoreContainerFileBlock record 的每个字段)依照下述规则解密:</p> <ul><li>derived encryption key 必须通过 password hash 和 block number 为 0 产生</li> <li>字段的长度必须通过 derived encryption key 进行解密</li></ul> <h3 id="encryption"><a href="#encryption" class="header-anchor">#</a> Encryption</h3> <p>ppt 文档中可能有一个名字为 &quot;EncryptedSummary&quot; 的可选流，它只在被加密的文档中存在。当这个流存在时，也必定存在一个名为 &quot;\0x05DocumentSummaryInformation&quot; 的流，而名为 &quot;\0x05SummaryInformation&quot; 则必定不能存在。</p> <p>关于 &quot;EncryptedSummary&quot; 这个 Encrypted Summary Stream 的详细描述见 [MS-OFFCRYPTO] section 2.3.5.4。</p> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ul><li><a href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-offfflp/8aea05e3-8c1e-4a9a-9614-31f71e679456" target="_blank" rel="noopener noreferrer">[MS-Office File Formats]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-xls/cd03cb5f-ca02-4934-a391-bb674cb8aa06" target="_blank" rel="noopener noreferrer">[MS-XLS] - v20210817<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-offcrypto/3c34d72a-1a61-4b52-a893-196f9157f083" target="_blank" rel="noopener noreferrer">[MS-OFFCRYPTO] - v20210817<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <div class="tags"><a href="/blog/tags/?tag=ole" title="标签">#ole</a><a href="/blog/tags/?tag=ms-cfb" title="标签">#ms-cfb</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/blog/platform/windwos_qt_base.html"><div>
            Qt 基础汇总
            <!----></div></a> <span class="date">04-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/blog/lang/cxx_static_analyze.html"><div>
            Cxx Static Analyze
            <!----></div></a> <span class="date">04-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/blog/lang/cxx_features.html"><div>
            CXX features
            <!----></div></a> <span class="date">04-02</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:929843628@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/joyous-x" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2022
    <span>Jiao | <a href="https://github.com/joyous-x/blog/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.f4337a00.js" defer></script><script src="/blog/assets/js/3.0f18b0bf.js" defer></script><script src="/blog/assets/js/20.aab0c43c.js" defer></script>
  </body>
</html>
