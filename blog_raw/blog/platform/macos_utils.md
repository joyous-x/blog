---
title: MacOS 要点记录
date: 2022-04-18 13:50:00
description: MacOS
categories: 
  - platform
tags: 
  - MacOS
permalink:
---

# MacOS 要点记录


。首先，我们提交给苹果的，是一个ipa文件，里面的bin文件，都是编译好的二进制可执行文件，苹果生态中叫做machO格式，machO格式定义了各种分段，比如引用的库列表，定义的类列表，方法列表，协议列表，字符串列表，然后又在一个地址映射表中记载着这些类，方法的对应关系，和实际的机器码机址。苹果只要对这些特定的段进行扫描，就能扫出来有没有引用一些非公开的API，类，系统库。

私有库的引用，这个是绝对不能出现的；
有虚拟物品内购的产品引用了第三方支付，这个也是严令禁止的；
只有声明，但没有实现的方法名，如果命中了，这个被拒的概率是非常非常高的；
所有的类名，切记不能与系统的私有类同名，为了减少被拒的可能性，还是换个名字吧；
所有的字符串，能不与系统的私有类同名的，还是尽量不要同名，为了减少被拒的可能性，还是换个名字吧；
苹果扫描的私有API库，是会针对所有固件版本的；
还有部分应用还会执行运行时扫描，不管你用什么方法混淆，加密，拼接，都会被苹果发现。


## AppVest

苹果审核大体分为三部分，预审、机审和人工审核。目前应用提审的整个流程大体分为五个阶段：Prepare For Upload（准备上传）、Waiting For Review（等待审核）、 In Review（审核）、Pending Developer Release(等待开发者发布)、Ready For Sale（准备销售）。

机审主要是对代码进行机器审核，排查APP是否重复应用

通过后会进入In Review（审核）阶段，即人工审核阶段，这个阶段主要看的是App的元数据，例如APP封面、功能、体验等等，注重用户体验。



在中国区，一个主包下有多个分包是常态，所以在同一设备对多个苹果账号开启双重验证的话，很容易将账号之间关联起来，这也是给各开发者的一个难题。

    配置文件（Info.plist）
        Info.plist是一种结构化的文本文件，通常所说的 “属性列表”,iOS的app都使用Info.plist文件来存储元信息，用来实现决定bundle所显示的icon，当前app支持打开的文档类型，服务声明等等。

    私有API检查（Private API）
        私有API检查是指放在PrivateFrameworks框架中的API

        获取头文件方法和成员的列表：使用Otool等工具，对ipa的可执行文件进行反编译解析，获取头文件中方法和成员的列表；

    存储系统检查

    链接
        隐私政策网址
    截屏
        截屏不准确
        截屏相似度 ？
    苹果审核人员确实会开VPN测试国内的APP
    会进行 Mock测试，修改你的返回信息，然后看你的APP是否有隐藏的功能 ？

    版本号最好加密一下再返回给你，让审核人员看不出来是版本号

    出包机器、上传应用机器\提交的IP地址

    3.1.1 第三方支付

    Guideline 2.3.1 - Performance

    Guideline 4.3 - Design - Spam (重复应用)
        苹果给我们应用4.3的反馈可以从三方面来考虑，一是元数据，二是代码，三是应用界面。
        元数据
            App的应用元数据指的是我们需要在开发者后台所填写的资料，包括但不限于标题、简介、关键词等
            为了避免与线上应用重复，我们在元数据上也应该注意，比如icon、展示图、关键词、应用简介这些都要保持唯一性，对于过审是有帮助的
            苹果重点监测的词尽量不要使用，除非公司硬性要求，比如彩票这种，还有其他热门应用的品牌词不要使用，会被苹果官方认为会给用户造成误导，从而被拒。
        混淆
            可以降低反馈4.3的概率，但是近几个月来，苹果对机器审核进行了升级，如果检测到我们代码混淆比较明显的话，就会给我们2.3.1的反馈


我们不得不仔细研究了苹果的审核条款以及采用逆向思维（假如我是审核员，我会怎么审核我们提交的APP）来分析审核中出现的问题。


Simian
MachOView查看mach-o的原始数据（iOS可执行文件格式）
frida适用于开发人员，逆向工程师和安全研究人员的动态检测工具包。


ipa包特征
主要包括功能、代码和相关资源

修改功能特征
根据之前的App删除或添加部分功能,不能完全使用之前的功能

混淆代码
一般通过修改工程中文件夹名字、修改项目名字、修改类名，并添加一些垃圾代码，要求代码的相似程度不高于45%。但这类混淆方式大家用的多了，苹果爸爸也会加强这方面的审核技术，比如最近因为“热更新”下架的拼多多。这里推荐用一些比较高级的代码混淆技术来提高过审几率，例如顶象技术的iOS安全编译器来混淆代码的，主要还免费。

开发者帐号
两个马甲包不要关联到同一个开发者帐号的信息；比如打包时关联。并且苹果对开发者帐号会进行权重管理，权重越低的帐号，审核越严格。同样的包，可能在权重高的帐号上就能过，在权重低的帐号上就是4.3。

打包环境
包括打包的电脑、IP地址，每台MAC上最好打包马甲包不要超过5个，上传马甲包时，IP不要跟其他马甲包的IP相同，并且注意相同的马甲包提交至少间隔一天以上。

材料相似
这里主要是指APP名字及描述、商店宣传图、搜索关键词、主色调、UI风格、ICON、版权人等材料出现相似，这里一定不要出现相同。即使是前边没审核过的包，也不要跟他们有关联。尤其是前边被4.3拒绝的包，更不能跟他们有相似性



二、审核上架
机审：
 嵌入的SDK需要单独申请；
 代码相似问题解决方案：
1.ipa包特征：
• 包括有代码相似性，资源相似性；
代码相似性解决办法：
• 已有代码的混淆（改类名、改函数名、改文件名、改工程名）；
• 添加一些无用的代码；
资源相似性解决办法：
• 资源改名；
• 适当添加一些无用的资源；
2.开发者帐号：
• 马甲包尽量不要关联到同一个开发者帐号；
3.元数据配置相似性：
• 针对收费产品，可以修改应用程序价格，打造与原产品不同的价格级别；
• 修改应用程序发布地区，打造与原产品不同的售卖地区或分不同地区运营；
• 修改产品分类，打造与原产品不同的产品侧重属性分类。

人审：
 测试账号，演示账号与主包不能一样；
 包名Bundle ID不能与主包类似，主包Bundle ID：com.xiaomi.loan；
 版本号从1.0开始，不要和主包版本一样；
 App图标，标题&副标题，应用介绍，地区，营销截图（屏幕快照），支持网站，隐私协议网站（如果添加的话）和主包都不能一样；
 最好是后端做控制开关，不更新应用也可以更新APP里的内容。

其他：
 马甲包激活数据能否提供 ;
 马甲包用户数据库独立，不使用主包的库（主要用于IDFA排重）;
 提交审核时尽量更换电脑提交，不要和主包用同一台电脑。

## Reference
- [](https://zhuanlan.zhihu.com/p/113436475)
- [](https://zfj1128.blog.csdn.net/article/details/95482006)

[iOS 马甲包2022过审经验总结 - 掘金](https://juejin.cn/post/7057832906504290311)
https://gitee.com/yanjinsheng/confuse
https://zhuanlan.zhihu.com/p/113436475
https://bbs.pediy.com/thread-221030.htm
https://blog.csdn.net/weixin_42325823/article/details/103769799

- [App Review](https://developer.apple.com/cn/app-store/review/)


[建立一套扫描方法](https://zhuanlan.zhihu.com/p/101222974)
[掀开马甲包的 “神秘面纱”](http://wd.nnjjkj.com/article/20.html)
[马甲包上架注意事项](http://wd.nnjjkj.com/article/22.html)

代码相似度分析：
    https://copycat.gitee.com/
    NiCad Clone Detector 
        https://blog.csdn.net/CYCHEN520/article/details/102033709
Moss是斯坦福开发的一个软件抄袭检查工具。这个工具对代码进行语义分析和特征分析，所以对原始代码进行简单的重命名和重构是根本没有用的。经过实验，对所有变量函数重命名、重构之后Moss仍然能发现70%的相似性.
    http://theory.stanford.edu/~aiken/moss/
    https://blog.csdn.net/henu_1710252529/article/details/101130242

ZFJObsLib-iOS代码混淆工具-马甲包混淆工具
    https://zfj1128.blog.csdn.net/article/details/95482006

iOS马甲包预审分析工具
    https://blog.csdn.net/box_kun/article/details/124823230